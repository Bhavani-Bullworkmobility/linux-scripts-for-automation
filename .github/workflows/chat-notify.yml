name: SonarQube Scan, Deploy & Notify

on:
  push:
    branches:
      - main
      - Release
      - Stage
      - Development

jobs:
  sonar-deploy:
    # âœ… Run ONLY for merge commits
    if: startsWith(github.event.head_commit.message, 'Merge pull request')

    runs-on: ubuntu-latest
    name: Lint â†’ SonarQube â†’ Deploy â†’ Notify

    steps:
      # --------------------
      # ğŸ§© CHECKOUT CODE
      # --------------------
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------
      # ğŸŒ± DETERMINE ENVIRONMENT
      # --------------------
      - name: ğŸŒ± Determine Environment
        id: env
        run: |
          case "${GITHUB_REF_NAME}" in
            main)
              echo "stage_name=Main" >> $GITHUB_OUTPUT
              ;;
            Release)
              echo "stage_name=Release" >> $GITHUB_OUTPUT
              ;;
            Stage)
              echo "stage_name=Stage" >> $GITHUB_OUTPUT
              ;;
            Development)
              echo "stage_name=Development" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "stage_name=Unknown" >> $GITHUB_OUTPUT
              ;;
          esac

      # --------------------
      # ğŸ SETUP PYTHON
      # --------------------
      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------
      # ğŸ“¦ INSTALL DEPENDENCIES
      # --------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip --quiet
          pip install -r requirements.txt --quiet || echo "âš ï¸ requirements.txt missing â€” skipping."

      # --------------------
      # ğŸ§¹ LINT (FAIL PIPELINE IF ERRORS)
      # --------------------
      - name: ğŸ§¹ Run Lint (fail on errors)
        run: |
          pip install flake8 --quiet

          echo "ğŸ” Running flake8..."
          flake8 . > lint_raw.txt || true

          ERRORS=$(grep -E " (E|F)[0-9]+" lint_raw.txt | wc -l | tr -d ' ')
          WARNINGS=$(grep -E " W[0-9]+" lint_raw.txt | wc -l | tr -d ' ')

          echo ""
          echo "==================== ğŸ§¹ LINT SUMMARY ===================="
          echo "Errors   : ${ERRORS}"
          echo "Warnings : ${WARNINGS}"
          echo "========================================================="
          echo ""

          if [ "$ERRORS" -gt 0 ]; then
            echo "âŒ Lint errors found. Stopping pipeline."
            exit 1
          fi

          echo "âœ… No lint errors. Proceeding."

      # --------------------
      # ğŸ” SONARQUBE SCAN
      # --------------------
      - name: ğŸ” Run SonarQube Scanner
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=Trinetra-Parser
            -Dsonar.projectName=Trinetra-Parser
            -Dsonar.sources=.
            -Dsonar.language=py
            -Dsonar.python.version=3.11
            -Dsonar.verbose=false

      # --------------------
      # âœ… QUALITY GATE CHECK
      # --------------------
      - name: âœ… Check Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # --------------------
      # ğŸ” AUTHENTICATE WITH GCP
      # --------------------
      - name: ğŸ” Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # --------------------
      # â˜ï¸ SETUP GCLOUD
      # -------------------
      - name: â˜ï¸ Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: trinetra-f5eeb
          install_components: kubectl

      # --------------------
      # ğŸš€ TRIGGER CLOUD BUILD
      # --------------------
      - name: ğŸš€ Trigger Cloud Build
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)

          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_COMMIT_SHA="${SHORT_SHA}" \
            --format="value(id)" \
            --quiet)

          STATUS=$(gcloud builds describe "$BUILD_ID" --format="value(status)")

          if [[ "$STATUS" != "SUCCESS" ]]; then
            echo "âŒ Deployment failed"
            exit 1
          fi

          echo "ğŸ‰ Deployment SUCCESS"

      # --------------------
      # ğŸ’¬ GOOGLE CHAT NOTIFICATION
      # --------------------
      - name: ğŸ’¬ Notify Google Chat
        if: always()
        uses: google-github-actions/send-google-chat-webhook@v0.0.2
        with:
          webhook_url: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
          text: |
            ğŸš€ **Pipeline Status**

            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Environment:** ${{ steps.env.outputs.stage_name }}
            **Triggered By:** ${{ github.actor }}
            **Workflow:** ${{ github.workflow }}
            **Commit SHA:** ${{ github.sha }}
            **Result:** ${{ job.status }}

            ğŸ•’ **Time (UTC):** ${{ github.event.head_commit.timestamp }}

            ğŸ”— **View Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
