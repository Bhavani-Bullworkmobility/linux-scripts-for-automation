name: PR Merge Guard
on:
  push:
    branches:
      - Development
      - Stage
      - Release

jobs:
  gatekeeper:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # Only need the most recent commit message

      - name: Validate Merge Message
        run: |
          # Retrieve the first line of the latest commit message
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          
          echo "Checking Message: $COMMIT_MSG"

          # Regex looks for "Merge pull request #[numbers] from [any-text]"
          if [[ "$COMMIT_MSG" =~ ^Merge\ pull\ request\ #[0-9]+\ from\ .* ]]; then
            echo "✅ Validated: This is a merged Pull Request."
            exit 0
          else
            echo "❌ ERROR: Direct push detected."
            echo "You must use a Pull Request to update this branch."
            exit 1
          fi

  # This job will only run if the gatekeeper above finishes with exit 0
  proceed-to-work:
    needs: gatekeeper
    runs-on: ubuntu-latest
    steps:
      - name: Success
        run: echo "The check passed. Put your next steps here..."